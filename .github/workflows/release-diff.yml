name: Build diff and release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute previous tag
        id: prev
        run: |
          set -e
          if git describe --tags --abbrev=0 --match "v*" HEAD^ >/dev/null 2>&1; then
            echo "prev_tag=$(git describe --tags --abbrev=0 --match 'v*' HEAD^)" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Prepare update folder (diff only, no recursion)
        run: |
          set -e
          mkdir -p update
          if [ -z "${{ steps.prev.outputs.prev_tag }}" ]; then
            # 1Ã¨re release : prendre UNIQUEMENT les fichiers suivis par git,
            # et exclure .github / fichiers de meta
            git ls-files -z | \
              grep -zvE '^(README|LICENSE|CHANGELOG|\.gitignore|\.gitattributes|\.github/)' | \
              xargs -0 -I{} bash -lc 'mkdir -p "update/$(dirname "{}")"; cp "{}" "update/{}"'
            : > update/deletes.txt
          else
            git diff --name-only ${{ steps.prev.outputs.prev_tag }}..HEAD > files.txt
            git diff --diff-filter=D --name-only ${{ steps.prev.outputs.prev_tag }}..HEAD > update/deletes.txt
            while IFS= read -r f; do
              [ -n "$f" ] || continue
              if [ -f "$f" ]; then
                mkdir -p "update/$(dirname "$f")"
                cp "$f" "update/$f"
              fi
            done < files.txt
          fi
          # Version depuis le tag (sans le 'v')
          echo "${GITHUB_REF_NAME#v}" > update/version.txt
          cp update/version.txt version.txt

      - name: Create zip
        run: |
          cd update
          zip -r ../update.zip .
          cd ..
          sha256sum update.zip > update.zip.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            update.zip
            update.zip.sha256
            version.txt

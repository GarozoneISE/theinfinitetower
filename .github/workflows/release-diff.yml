name: Build diff and release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute previous tag
        id: prev
        run: |
          set -e
          if git describe --tags --abbrev=0 --match "v*" HEAD^ >/dev/null 2>&1; then
            echo "prev_tag=$(git describe --tags --abbrev=0 --match 'v*' HEAD^)" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Prepare update folder (diff only, no recursion)
        run: |
          set -e
          mkdir -p update
          if [ -z "${{ steps.prev.outputs.prev_tag }}" ]; then
            # 1ère release : copier UNIQUEMENT les fichiers suivis par git, en excluant .github et meta
            git ls-files -z -- . ':!/.github' ':!/.github/**' ':!README*' ':!LICENSE*' ':!CHANGELOG*' ':!*.md' \
              | while IFS= read -r -d '' f; do
                  mkdir -p "update/$(dirname "$f")"
                  cp "$f" "update/$f"
                done
            : > update/deletes.txt
          else
            # Diff depuis le tag précédent
            git diff --name-only ${{ steps.prev.outputs.prev_tag }}..HEAD > files.txt
            git diff --diff-filter=D --name-only ${{ steps.prev.outputs.prev_tag }}..HEAD > update/deletes.txt
            grep -vE '^(\.github/|README|LICENSE|CHANGELOG|.*\.md$)' files.txt | while read -r f; do
              [ -f "$f" ] || continue
              mkdir -p "update/$(dirname "$f")"
              cp "$f" "update/$f"
            done
          fi
          # Version (sans le 'v')
          echo "${GITHUB_REF_NAME#v}" > update/version.txt
          cp update/version.txt version.txt

      - name: Create zip
        run: |
          cd update
          zip -r ../update.zip .
          cd ..
          sha256sum update.zip > update.zip.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            update.zip
            update.zip.sha256
            version.txt
